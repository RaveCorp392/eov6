rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isAgent() {
      return request.auth != null &&
             (request.auth.token.role in ['agent','admin','owner']);
    }
    function isCallerFor(code) {
      return request.auth != null &&
             request.auth.token.sessionCode == code;
    }
    function isParticipant(code) { return isAgent() || isCallerFor(code); }
    function sessionDoc(code) { return get(/databases/$(database)/documents/sessions/$(code)); }
    function sessionData(code) {
      let doc = sessionDoc(code);
      return doc != null ? doc.data : null;
    }
    function isActiveData(data) {
      return data != null &&
             data.closed != true &&
             (!(data.expiresAt is timestamp) || data.expiresAt > request.time);
    }
    function isActive(code) { return isActiveData(sessionData(code)); }

    match /{document=**} { allow read, write: if false; }

    match /sessions/{code} {
      allow read: if isParticipant(code) && isActiveData(resource.data);
      allow create: if isAgent() && isActiveData(request.resource.data);
      allow update: if isParticipant(code) && isActive(code);
      allow delete: if false;

      match /messages/{id} {
        allow read: if isParticipant(code) && isActive(code);
        allow create: if isParticipant(code) && isActive(code)
          && request.resource.data.keys().hasAll(['role','type','createdAt'])
          && request.resource.data.role in ['caller','agent','system']
          && request.resource.data.type in ['text','file','details','system']
          && request.resource.data.createdAt is timestamp
          && request.resource.data.createdAt <= request.time
          && (!('text' in request.resource.data) || (request.resource.data.text is string && request.resource.data.text.size() <= 4096));
        allow update, delete: if false;
      }
      match /fields/{field} {
        allow read: if isParticipant(code) && isActive(code);
        allow create, update: if isParticipant(code) && isActive(code);
        allow delete: if false;
      }
      match /details/{docId} {
        allow read: if isParticipant(code) && isActive(code);
        allow create, update: if isParticipant(code) && isActive(code);
        allow delete: if false;
      }
      match /profile/{docId} {
        allow read: if isParticipant(code) && isActive(code);
        allow create, update: if isParticipant(code) && isActive(code);
        allow delete: if false;
      }
    }

    match /jobs/{doc=**} { allow read, write: if false; }
  }
}
