'use client';import {useEffect,useRef,useState} from 'react';import {collection,query,orderBy,onSnapshot,addDoc,serverTimestamp} from 'firebase/firestore';import {db} from '@/lib/firebase';import {expiryInHours} from '@/lib/code';
export default function ChatWindow({role,code}:{role:'agent'|'caller';code:string}){const[msgs,setMsgs]=useState<any[]>([]);const[text,setText]=useState('');const scroller=useRef<HTMLDivElement>(null);useEffect(()=>{const q=query(collection(db,'sessions',code,'messages'),orderBy('ts','asc'));const unsub=onSnapshot(q,snap=>{setMsgs(snap.docs.map(d=>({id:d.id,...d.data()})));queueMicrotask(()=>scroller.current?.scrollTo({top:999999,behavior:'smooth'}))});return()=>unsub()},[code]);async function send(){const t=text.trim();if(!t)return;setText('');await addDoc(collection(db,'sessions',code,'messages'),{role,text:t,ts:serverTimestamp(),expiresAt:expiryInHours(1)} as any)}return(<div className='space-y-2'><div ref={scroller} className='h-[360px] w-full overflow-y-auto rounded-xl border bg-white p-3'>{msgs.map(m=>(<div key={m.id} className={`mb-2 max-w-[75%] rounded-xl px-3 py-2 ${m.role==='agent'?'bg-blue-50 ml-auto':'bg-gray-100'}`}>{m.text}</div>))}</div><form onSubmit={e=>{e.preventDefault();void send()}} className='flex items-center gap-2'><input value={text} onChange={e=>setText(e.target.value)} placeholder='Type a message' className='flex-1 rounded-xl border px-3 py-2'/><button className='rounded-xl bg-blue-700 px-4 py-2 text-white'>Send</button></form></div>)}

