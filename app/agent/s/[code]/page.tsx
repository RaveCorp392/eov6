'use client';import {useEffect,useState} from 'react';import {useParams} from 'next/navigation';import ChatWindow from '@/components/ChatWindow';import {db,isFirebaseReady} from '@/lib/firebase';import {doc,onSnapshot,collection,addDoc,serverTimestamp,setDoc} from 'firebase/firestore';import {expiryInHours} from '@/lib/code';type Profile={name?:string;email?:string;phone?:string};export default function AgentS(){const {code}=useParams<{code:string}>();const using=isFirebaseReady();const[profile,setProfile]=useState<Profile>({});const invite=`https://eov6.com/s/${code}`;useEffect(()=>{if(!using)return;const ref=doc(db,'sessions',code);return onSnapshot(ref,snap=>setProfile((snap.data()?.profile)||{}))},[code,using]);async function ask(type:'name'|'email'|'phone'){if(!using)return;const text=type==='name'?'Could you please provide your full name?':type==='email'?'Could you please provide your best email address?':'Could you please provide a phone number we can reach you on?';await addDoc(collection(db,'sessions',code,'messages'),{role:'agent',text,ts:serverTimestamp(),expiresAt:expiryInHours(1)} as any)}async function save(k:keyof Profile,v:string){if(!using)return;const next={...(profile||{}),[k]:v};setProfile(next);await setDoc(doc(db,'sessions',code),{profile:next},{merge:true})}return(<main className='space-y-4'><div className='rounded-xl border p-3 text-sm'>Session <b>{code}</b> â€¢ Share with caller:<button className='ml-2 rounded-md border px-2 py-1 text-xs' onClick={()=>navigator.clipboard.writeText(invite)} title={invite}>Copy invite</button><span className='ml-2 text-xs text-gray-500'>{invite}</span></div><div className='grid grid-cols-1 gap-2 sm:grid-cols-3'><input className='rounded-xl border px-3 py-2' placeholder='Full name' defaultValue={profile?.name||''} onBlur={e=>save('name',e.target.value)}/><input className='rounded-xl border px-3 py-2' placeholder='Email' type='email' defaultValue={profile?.email||''} onBlur={e=>save('email',e.target.value)}/><input className='rounded-xl border px-3 py-2' placeholder='Phone' type='tel' defaultValue={profile?.phone||''} onBlur={e=>save('phone',e.target.value)}/></div><ChatWindow role='agent' code={code}/><div className='grid grid-cols-1 gap-2 sm:grid-cols-3'><button className='rounded-xl border px-3 py-2' onClick={()=>ask('name')}>Ask name</button><button className='rounded-xl border px-3 py-2' onClick={()=>ask('email')}>Ask email</button><button className='rounded-xl border px-3 py-2' onClick={()=>ask('phone')}>Ask phone</button></div><button className='w-full rounded-xl bg-red-600 px-4 py-3 text-white'>End session</button></main>)}
