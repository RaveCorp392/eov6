'use client';import {useState} from 'react';import {db,isFirebaseReady} from '@/lib/firebase';import {doc,getDoc,setDoc,serverTimestamp} from 'firebase/firestore';import {randomCode,defaultCodeLength,expiryInHours} from '@/lib/code';export default function IVR(){const[name,setName]=useState('');const[email,setEmail]=useState('');const[phone,setPhone]=useState('');const[code,setCode]=useState<string|null>(null);const[busy,setBusy]=useState(false);async function create(){if(!isFirebaseReady())return alert('Firebase not ready.');setBusy(true);try{for(let i=0;i<20;i++){const c=randomCode(defaultCodeLength);const ref=doc(db,'sessions',c);const snap=await getDoc(ref);if(!snap.exists()){await setDoc(ref,{createdAt:serverTimestamp(),expiresAt:expiryInHours(1),status:'prefilled',profile:{name,email,phone}},{merge:true});setCode(c);return}}alert('Could not allocate a code, please try again.')}finally{setBusy(false)}}const link=code?`https://agent.eov6.com/agent/s/${code}`:'';return(<main className='mx-auto max-w-xl space-y-4'><h1 className='text-xl font-semibold'>IVR initiated session</h1><div className='grid grid-cols-1 gap-2'><input className='rounded-xl border px-3 py-2' placeholder='Full name' value={name} onChange={e=>setName(e.target.value)}/><input className='rounded-xl border px-3 py-2' placeholder='Email' type='email' value={email} onChange={e=>setEmail(e.target.value)}/><input className='rounded-xl border px-3 py-2' placeholder='Phone' type='tel' value={phone} onChange={e=>setPhone(e.target.value)}/></div><button className='rounded-xl bg-blue-700 px-4 py-3 text-white disabled:opacity-50' onClick={create} disabled={busy}>{busy?'Creating…':'Create & get code'}</button>{code&&(<div className='rounded-xl border bg-white p-3 text-sm'>Code: <b>{code}</b> • Agent link: <a className='text-blue-700 underline' href={link}>{link}</a></div>)}</main>)}
